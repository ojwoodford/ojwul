%INV44N Compute the inverse of an array of 4x4 matrices
%
%   [B, d] = inv44n(A)
%
% Vectorized computation of the inverse of multiple 4x4 matrices.
%
%IN:
%   A - 4x4xN array.
%
%OUT:
%   B - 4x4xN array, where B(:,:,a) = inv(A(:,:,a)).
%   d - 1xN array, where d(a) = det(A(:,:,a)).

function [B, det] = inv44n(A)
s0 = A(1,1,:) .* A(2,2,:) - A(2,1,:) .* A(1,2,:);
s1 = A(1,1,:) .* A(2,3,:) - A(2,1,:) .* A(1,3,:);
s2 = A(1,1,:) .* A(2,4,:) - A(2,1,:) .* A(1,4,:);
s3 = A(1,2,:) .* A(2,3,:) - A(2,2,:) .* A(1,3,:);
s4 = A(1,2,:) .* A(2,4,:) - A(2,2,:) .* A(1,4,:);
s5 = A(1,3,:) .* A(2,4,:) - A(2,3,:) .* A(1,4,:);

c5 = A(3,3,:) .* A(4,4,:) - A(4,3,:) .* A(3,4,:);
c4 = A(3,2,:) .* A(4,4,:) - A(4,2,:) .* A(3,4,:);
c3 = A(3,2,:) .* A(4,3,:) - A(4,2,:) .* A(3,3,:);
c2 = A(3,1,:) .* A(4,4,:) - A(4,1,:) .* A(3,4,:);
c1 = A(3,1,:) .* A(4,3,:) - A(4,1,:) .* A(3,3,:);
c0 = A(3,1,:) .* A(4,2,:) - A(4,1,:) .* A(3,2,:);

det = s0 .* c5 - s1 .* c4 + s2 .* c3 + s3 .* c2 - s4 .* c1 + s5 .* c0;
invdet = 1 ./ det;

B(1,1,:) = ( A(2,2,:) .* c5 - A(2,3,:) .* c4 + A(2,4,:) .* c3) .* invdet;
B(1,2,:) = (-A(1,2,:) .* c5 + A(1,3,:) .* c4 - A(1,4,:) .* c3) .* invdet;
B(1,3,:) = ( A(4,2,:) .* s5 - A(4,3,:) .* s4 + A(4,4,:) .* s3) .* invdet;
B(1,4,:) = (-A(3,2,:) .* s5 + A(3,3,:) .* s4 - A(3,4,:) .* s3) .* invdet;

B(2,1,:) = (-A(2,1,:) .* c5 + A(2,3,:) .* c2 - A(2,4,:) .* c1) .* invdet;
B(2,2,:) = ( A(1,1,:) .* c5 - A(1,3,:) .* c2 + A(1,4,:) .* c1) .* invdet;
B(2,3,:) = (-A(4,1,:) .* s5 + A(4,3,:) .* s2 - A(4,4,:) .* s1) .* invdet;
B(2,4,:) = ( A(3,1,:) .* s5 - A(3,3,:) .* s2 + A(3,4,:) .* s1) .* invdet;

B(3,1,:) = ( A(2,1,:) .* c4 - A(2,2,:) .* c2 + A(2,4,:) .* c0) .* invdet;
B(3,2,:) = (-A(1,1,:) .* c4 + A(1,2,:) .* c2 - A(1,4,:) .* c0) .* invdet;
B(3,3,:) = ( A(4,1,:) .* s4 - A(4,2,:) .* s2 + A(4,4,:) .* s0) .* invdet;
B(3,4,:) = (-A(3,1,:) .* s4 + A(3,2,:) .* s2 - A(3,4,:) .* s0) .* invdet;

B(4,1,:) = (-A(2,1,:) .* c3 + A(2,2,:) .* c1 - A(2,3,:) .* c0) .* invdet;
B(4,2,:) = ( A(1,1,:) .* c3 - A(1,2,:) .* c1 + A(1,3,:) .* c0) .* invdet;
B(4,3,:) = (-A(4,1,:) .* s3 + A(4,2,:) .* s1 - A(4,3,:) .* s0) .* invdet;
B(4,4,:) = ( A(3,1,:) .* s3 - A(3,2,:) .* s1 + A(3,3,:) .* s0) .* invdet;
end
